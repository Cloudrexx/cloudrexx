<div class="grid-elm grid-align-1-1 grid-offset">
    <div class="multisite-status"></div>
    <div class="multisite-form">
        <form role="form" id="multisite_copy_form">
            <input type="hidden" name="websiteId" id="websiteId" value="{MULTISITE_WEBSITE_ID}" />
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h2>{MULTISITE_COPY_WEBSITE}</h2>
            <div class="alert alert-success" role="alert">
                {TXT_MULTISITE_WEBSITE_COPY_DESCRIPTION}
            </div>
            <fieldset>
                <div class="row">

                    <div class="form-group">
                        <div class="input-group multisite-address">
                            <input  data-bv-notempty="true" data-bv-notempty-message=" " data-bv-callback="true" data-bv-callback-callback="validateAdress"  id="multisite_address" name="multisite_address" type="text" title="{TXT_MULTISITE_SITE_ADDRESS_INFO}" class="form-control" value="" required="">
                            <div class="input-group-addon">.{MULTISITE_DOMAIN}</div>
                        </div>
                    </div>
                    
                    <div class="form-inline">
                        <div class="form-group col-md-8 no-padding-left">
                            <select class="col-md-12 no-padding" data-bv-notempty="true" data-bv-notempty-message=""  id="multisite_subscription" name="subscription" class="form-control">
                                <option value="">{TXT_MULTISITE_WEBSITE_CHOOSE_SUBSCRIPTION}</option>
                                <!-- BEGIN openSubscriptions -->
                                <option value="{MULTISITE_SUBSCRIPTION_ID}">{MULTISITE_SUBSCRIPTION_NAME}</option>
                                <!-- END openSubscriptions -->
                            </select>
                        </div>
                        <div class="form-group col-md-4 no-padding">
                            <button type="button" class="add col-md-12 addSubscription" data-remote="/api/MultiSite/SubscriptionSelection" data-target="SubscriptionSelection">{TXT_MULTISITE_NEW_SUBSCRIPTION}</button>
                        </div>
                    </div>
                </div>
                <div class="row">&nbsp;</div>
                <div class="row">
                    <button type="button" class="copy multisite_submit">{TXT_MULTISITE_WEBSITE_COPY}</button>                    
                    <button type="button" data-dismiss="modal">{TXT_MULTISITE_CLOSE}</button>
                </div>

            </fieldset>
        </form>
    </div>
    <div class="modal-body multisite-progress">
        <div></div>
    </div>
</div>
<script type="text/javascript">
    var validateAdress = function (value, validator, $field) {
        var message = '';
        if (!value.match(/^[a-z0-9]+$/)) {
            message +=  'Im Domainnamen d√ºrfen nur Kleinbuchstaben und Zahlen vorkommen.';
        }
        if (jQuery($field).data('server-msg') != true && jQuery($field).data('server-msg')){
            message +=   jQuery($field).data('server-msg') ;
        }
        if (message != '') {
            return {
                valid: false,
                message: message
            };
        }
        return true;
    };
    jQuery(function(){
        jQuery('.addSubscription').on('click', function(){
            jQuery('#CopyWebsite').modal('hide');
            showRemoteModal({
              modalId   : 'SubscriptionSelection',
              remoteUrl : jQuery(this).data('remote'),
              loaded     : function() {
                  jQuery('#SubscriptionSelection #subscriptionCallbackModal').val('CopyWebsite');
                  jQuery('#SubscriptionSelection #subscriptionCallbackModalRemoteUrl').val('/api/MultiSite/CopyWebsite?id={MULTISITE_WEBSITE_ID}');
                  jQuery('#SubscriptionSelection #subscriptionCopyWebsite').val('{MULTISITE_WEBSITE_ID}');
              }
            });
       });
    });
    jQuery.getScript("{MULTISITE_PATH}/lib/javascript/jquery/bootstrapvalidator/js/bootstrapValidator.min.js", function() {
        jQuery.getScript('{MULTISITE_PATH}/core_modules/MultiSite/View/Script/SignUp.js', function() {
            function cxMultiSiteCopyWebsite() {
                var submitButtonRequested = false,
                    ongoingRequest = false,
                    submitRequested = false,
                    formId = 'multisite_copy_form',
                    objAddress,
                    copyForm = jQuery('#'+ formId),
                    objModal   = jQuery('#'+ formId).parents('.modal');
                var validatorDefaults = {
                    objForm: copyForm,
                    objModal: objModal,
                    systemErrorTxt: '{TXT_CORE_MODULE_MULTISITE_WEBSITE_COPY_ERROR_MSG}'
                };
                var validator = new multisiteFormValidator(validatorDefaults);
                var copyWebsite =function() {
                    try {                        
                        ongoingRequest = true;
                        validator.setFormButtonState('close', true, true);
                        validator.setFormButtonState('cancel', false, false);

                        validator.hideForm();
                        validator.showProgress('{TXT_MULTISITE_WEBSITE_COPY_PROGRESS} <img src="{MULTISITE_PATH}/lib/javascript/jquery/jstree/themes/default/throbber.gif" />');
                        jQuery.ajax({
                            dataType: "json",
                            url: '{MULTISITE_COPY_WEBSITE_URL}',
                            data: {
                                multisite_address : objAddress.val(),
                                websiteId: jQuery('#websiteId').val(),
                                subscriptionId : jQuery('#multisite_subscription').val()
                            },
                            type: "POST",
                            success: function(response){
                                var message, errorObject,errorMessage,errorType;

                                if (!response.status) {
                                    validator.showSystemError();
                                    return;
                                }
                                // handle signup
                                switch (response.status) {
                                    case 'success':
                                        // this is a workaround for 
                                        if (!response.message && !response.data) {
                                            validator.showSystemError();
                                            return;
                                        }
                                        // fetch message
                                        message = response.data.message;
                                        setMessage(message, 'success');
                                        setTimeout(function() {                                            
                                            window.location.href = '{NODE_MULTISITE_WEBSITE}?id=' + response.data.websiteId;
                                        }, 1000);
                                        break;

                                    case 'error':
                                    default:
                                        errorObject = null;
                                        errorType = 'danger';
                                        errorMessage = response.message;
                                        if (typeof (response.message) == 'object') {
                                            errorObject = typeof (response.message.object) != null ? response.message.object : null;
                                            errorMessage = typeof (response.message.message) != null ? response.message.message : null;
                                            errorType = typeof (response.message.type) != null ? response.message.type : null;
                                        }
                                        setMessage(errorMessage, errorType, errorObject);
                                        break;
                                }
                            },
                            error: function() {
                                validator.showSystemError();
                            }
                        });
                    } catch (e) {
                        console.log(e);
                    }
                }
                
                var submitForm = function() {
                    try {                        
                        if (!formValidation()) {
                            submitButtonRequested = true;
                            return;
                        }                        
                        validator.setFormButtonState('submit', true);
                        if (submitRequested) {
                            return;
                        }
                        submitRequested = true;                        
                        copyWebsite();
                    } catch (e) {

                    }

                    // always return false. We don't want to form to get actually submitted
                    // as everything is done using AJAX
                    return false;
                }

                function setMessage(message, type, errorObject) {
                    var objElement;
                    if (!type) type = 'info';
                    objElement = null;

                    switch (errorObject) {
                        case 'address':
                            if (!objElement) objElement = objAddress;
                            validator.setFormButtonState('close', false);
                            validator.setFormButtonState('cancel', true, true);
                            validator.hideProgress();
                            showForm();
                            jQuery('<div class="alert alert-' + type + '" role="alert">' + message + '</div>').insertAfter(objElement);
                            objElement.data('valid', false);
                            cancelCopy();

                            jQuery('#'+ formId).data('bootstrapValidator').updateStatus('multisite_address', 'NOT_VALIDATED');
                            break;
                        default:
                            validator.setFormButtonState('close', true, true);
                            validator.setFormButtonState('cancel', false);
                            validator.hideForm();
                            validator.hideProgress();
                            validator.setFormStatus(type, message);
                            cancelCopy();
                            break;
                    }
                }
                function cancelCopy() {
                    ongoingRequest = false;
                    submitRequested = false;
                }
                function formValidation() {
                    jQuery('#' + formId).data('bootstrapValidator').validate();
                    if (!isFormValid() || !jQuery('#' + formId).data('bootstrapValidator').isValid()) {
                        return false;
                    }
                    return true;
                }
                function verifyAddress() {
                    validator.verifyInput(this, {multisite_address : jQuery(this).val().toLowerCase()});
                }
                function isFormValid() {
                    if (objAddress.length && !objAddress.data('valid')) {
                        return false;
                    }
                    return true;
                }
                function showForm() {
                    objModal.find('.multisite-form').show();
                    jQuery('#CopyWebsite').find('.modal-body').css({'min-height': jQuery('#CopyWebsite').find('.multisite-form').height()});
                }
                
                jQuery('#'+ formId)
                    .bootstrapValidator()
                    .on('success.field.bv', function() {
                      if (submitButtonRequested) {
                        submitButtonRequested = false;
                        submitForm();
                      }
                    })
                    .on('error.field.bv', function() {
                      submitButtonRequested = false;
                    });

                objAddress = objModal.find('#multisite_address');
                objAddress.bind('change', verifyAddress);
                objAddress.data('verifyUrl', '{MULTISITE_ADDRESS_URL}');

                objAddress = objModal.find('#multisite_address');
                objAddress.bind('change', verifyAddress);

                jQuery('#'+ formId).submit(submitForm);
                objModal.find('.multisite_submit').on('click', submitForm);
            }
            cxMultiSiteCopyWebsite();
        });
    });
</script>